"""
    Project : FincLab

    Author : Peter Lee

Three components of the system are dynamic - it means that you could replace these components in the 'config.ini" file with other classes to override the default:

    strategy : class, default to "MovingAverageCrossover"
        Strategy transforms the data feeds into investment signals, which will be received by the Portfolio class to determine the appropriate order size. Different strategies are available in the strategy folder.

    data_handler : class, default to "HistoricDataHandler"
        DataHandler transforms time series data (or live streams) into periodic "bars" to feed the event-driven system. The "HistoricDataHandler" is suitable for backtesting.

    execution_handler: class, default to "SimulatedExecutionHandler"
        Execution_hanlder executes the orders generated by the Portfolio class. The default "SimulatedExecutionHandler" assumes Interactive Brokers' brokerage fee and ignores market microstructure issues such as slippage, fill ratios etc.
"""

import datetime as dt
import queue
import logging
from portfolio import Portfolio
from engine import Engine
from logger import Logger
from config import config

# Dynamically import the remaining system components
exec("from data.{module} import {module} as DataHandler".format(module=config["components"]["data_handler"]))
exec("from execution.{module} import {module} as ExecutionHandler".format(module=config["components"]["execution_handler"]))
exec("from strategy.{module} import {module} as Strategy".format(module=config["components"]["strategy"]))


# Initialise environment vars
event_queue = queue.Queue()
logger = Logger(logger_name="FincLab",
                logfile='log.txt',
                event_queue=event_queue,
                level=logging.DEBUG)

def finclab():
    # Program parameters
    initial_capital = 100000.0
    heartbeat = 0.0
    start_date = dt.datetime(2014, 1, 1, 0, 0, 0)
    symbol_list = ['AAPL']

    # Backtest
    engine = Engine(
        symbol_list=symbol_list,
        data_handler=DataHandler,
        execution_handler=ExecutionHandler,
        portfolio=Portfolio,
        strategy=Strategy,
        event_queue=event_queue,
        heartbeat=heartbeat,
        initial_capital=initial_capital,
        start_date=start_date
    )
    # engine.run()

if __name__ == "__main__":
    # formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')
    logger.info('calling temp.some_function()')
    logger.info('done with auxiliary_module.some_function()')

    finclab()
